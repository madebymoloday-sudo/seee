# Новая функция: Выбор части идеи для разбора

## Описание

После завершения работы с идеей (после вывода/conclusion) система автоматически предлагает разобрать части этой идеи, которые тоже являются идеями.

## Логика работы

### 1. После вывода о концепции

Когда пользователь отвечает на вопрос о выводе (conclusion), система:

1. ✅ Сохраняет ответ
2. ✅ Проверяет, есть ли части у идеи
3. ✅ Если части есть, автоматически задает вопрос:
   > "У вашей идеи «[название идеи]» есть такие части, которые так же являются идеями и их стоит разобрать. Какую из них вы хотите разобрать сейчас?"
4. ✅ Показывает список частей для выбора

### 2. Выбор части

Пользователь может:
- Выбрать часть из списка (клик или ввод номера/названия)
- Пропустить выбор части

### 3. Начало разбора выбранной части

После выбора части:
- Создается новая концепция с названием = выбранная часть
- Начинается разбор с первого вопроса (цель идеи)
- Часть связывается с исходной идеей через `extracted_from`

---

## Изменения в коде

### Backend (app_template.py)

#### 1. В `handle_message()` - после вывода

```python
# ЗАДАЧА: После вывода автоматически спрашиваем про части идеи
if current_field in ['conclusion', 'conclusions']:
    concept_name = current_concept.get('name', 'эта идея')
    parts = current_concept.get('composition', []) or current_concept.get('parts', [])
    
    if parts:
        # Формируем список частей
        parts_list = '\n'.join([f"{i+1}. {part}" for i, part in enumerate(parts)])
        next_question = f"У вашей идеи «{concept_name}» есть такие части, которые так же являются идеями и их стоит разобрать. Какую из них вы хотите разобрать сейчас?\n\n{parts_list}"
        
        current_concept['awaiting_part_selection'] = True
        current_concept['current_field'] = None
        
        emit('response', {
            'message': next_question,
            'parts_for_selection': parts,
            'awaiting_part_selection': True,
            ...
        })
```

#### 2. Обработка выбора части

```python
# Проверяем, ожидается ли выбор части
if current_concept and current_concept.get('awaiting_part_selection'):
    socket.emit('select_part_to_analyze', {
        'session_id': session_id,
        'selected_part': message,
        'source_concept_name': current_concept.get('name')
    })
    return
```

#### 3. Новый обработчик `select_part_to_analyze`

```python
@socketio.on('select_part_to_analyze')
def handle_select_part_to_analyze(data):
    # Определяем выбранную часть
    # Создаем новую концепцию
    # Начинаем разбор с первого вопроса
```

---

### Frontend (app.js)

#### 1. Обработка ответа с выбором части

```javascript
socket.on('response', function(data) {
    if (data.awaiting_part_selection && data.parts_for_selection) {
        showPartSelectionModal(data.parts_for_selection, data.message);
        return;
    }
    // ... остальная обработка
});
```

#### 2. Функция показа модального окна

```javascript
function showPartSelectionModal(parts, questionText) {
    // Создает модальное окно со списком частей
    // При клике на часть отправляет select_part_to_analyze
}
```

#### 3. Отправка выбора

```javascript
socket.emit('select_part_to_analyze', {
    session_id: currentSessionId,
    selected_part: part,
    source_concept_name: null
});
```

---

## Структура данных

### Исходная идея после завершения

```json
{
  "name": "Желание изменить восприятие людей через форму",
  "composition": [
    "создать последователей",
    "массовое движение",
    "продукт для изменения восприятия"
  ],
  "conclusions": "вывод о концепции",
  "awaiting_part_selection": true
}
```

### Новая идея из части

```json
{
  "name": "создать последователей",
  "composition": [],
  "founder": null,
  "purpose": null,
  "consequences": {
    "emotional": [],
    "physical": []
  },
  "conclusions": null,
  "extracted_from": "Желание изменить восприятие людей через форму",
  "extracted_part": "parts",
  "current_field": "goal"
}
```

---

## Поток работы

```
1. Пользователь отвечает на вопрос о выводе
   ↓
2. Система сохраняет вывод
   ↓
3. Система проверяет части идеи
   ↓
4. Если части есть:
   → Задает вопрос о выборе части
   → Показывает список частей
   ↓
5. Пользователь выбирает часть
   ↓
6. Система создает новую концепцию
   ↓
7. Начинается разбор новой идеи с первого вопроса
```

---

## Примеры

### Пример 1: Нормальный поток

**Идея:** "Желание изменить восприятие людей через форму"
**Части:** ["создать последователей", "массовое движение", "продукт"]

**После вывода:**
> "У вашей идеи «Желание изменить восприятие людей через форму» есть такие части, которые так же являются идеями и их стоит разобрать. Какую из них вы хотите разобрать сейчас?
> 
> 1. создать последователей
> 2. массовое движение
> 3. продукт"

**Пользователь выбирает:** "1" или "создать последователей"

**Результат:**
- Создается новая идея "создать последователей"
- Начинается разбор с вопроса о цели

---

### Пример 2: Пропуск выбора

**Пользователь нажимает:** "Пропустить"

**Результат:**
- Система завершает работу с идеей
- Предлагает обсудить что-то еще

---

## Интеграция

### Шаг 1: Backend

1. Добавьте обработку после вывода в `handle_message()`
2. Добавьте проверку `awaiting_part_selection` в начале `handle_message()`
3. Добавьте обработчик `@socketio.on('select_part_to_analyze')`

### Шаг 2: Frontend

1. Добавьте обработку `awaiting_part_selection` в `socket.on('response')`
2. Добавьте функцию `showPartSelectionModal()`
3. Добавьте CSS стили для модального окна

---

## Тестирование

### Тест 1: Нормальный поток

1. Завершите разбор идеи (ответьте на все вопросы до вывода)
2. Ответьте на вопрос о выводе
3. **ОЖИДАЕМО:** Система задает вопрос о выборе части
4. Выберите часть из списка
5. **ОЖИДАЕМО:** Начинается разбор новой идеи

### Тест 2: Пропуск

1. После вопроса о выборе части нажмите "Пропустить"
2. **ОЖИДАЕМО:** Система завершает работу с идеей

### Тест 3: Идея без частей

1. Завершите разбор идеи, у которой нет частей
2. **ОЖИДАЕМО:** Система просто завершает работу (не задает вопрос о частях)

---

## Важные замечания

1. **Автоматический переход:** Вопрос о частях задается автоматически, без дополнительных действий пользователя

2. **Связь идей:** Новая идея связана с исходной через `extracted_from`

3. **Структура:** Части берутся из `composition` или `parts` поля исходной идеи

4. **Выбор:** Пользователь может выбрать по номеру или названию

5. **Пропуск:** Можно пропустить выбор части, если не хотите разбирать части сейчас

---

## Готово!

После интеграции система будет:
- ✅ Автоматически предлагать разобрать части после вывода
- ✅ Показывать список частей для выбора
- ✅ Создавать новую идею из выбранной части
- ✅ Начинать разбор новой идеи

