# Изменения, необходимые на бэкенде

> **Важно:** Создан файл `app_template.py` с полным примером реализации всех изменений.

## Задача 3: Разделение физических и эмоциональных последствий

**✅ Хорошая новость:** Структура данных уже поддерживает разделение! В JSON файлах видно:
```json
"consequences": {
    "emotional": [],
    "physical": []
}
```

Нужно только изменить вопросы и логику обработки.

Необходимо изменить логику обработки последствий, чтобы разделять физические и эмоциональные последствия.

**Где изменить:**
- В обработчике вопросов о последствиях (вероятно в `app.py` или файле обработки психолога)

**Что изменить:**
1. Вместо одного вопроса "Какие последствия имеет эта идея?" использовать два вопроса:
   - "Какие эмоциональные последствия имеет эта идея?"
   - "Какие физические последствия имеет эта идея?"

2. Сохранять последствия в структуре концепции как:
   - `consequences_emotional` - массив эмоциональных последствий
   - `consequences_physical` - массив физических последствий

**Пример кода:**
```python
# Вместо:
concept['consequences'] = user_response

# Использовать:
if current_field == 'consequences_emotional':
    concept['consequences_emotional'] = user_response
elif current_field == 'consequences_physical':
    concept['consequences_physical'] = user_response
```

---

## Задача 7: Изменить вопрос после частей концепции

**Текущий вопрос:**
"Есть ли что-то ещё что вы хотели бы изменить или добавить к этой идее?"

**Новый вопрос:**
"Есть ли ещё какие-то части этой идеи или идём дальше?"

**Где изменить:**
- В обработчике после заполнения частей концепции
- Вероятно в файле обработки психолога или в `app.py`

**Также исправить обработку кнопки "Пропустить":**
- Когда пользователь нажимает "Пропустить" (теперь "Далее") после этого вопроса, не должно быть ответа "хорошо, пропустим состав"
- Вместо этого должен быть переход к следующему пункту структуры

**Пример:**
```python
# Вместо:
if skip_step:
    response = "Хорошо, пропустим состав"
    
# Использовать:
if skip_step:
    # Переходим к следующему полю структуры
    move_to_next_field()
```

---

## Задача 8: Изменить вопрос о цели идеи

**Текущий вопрос:**
"С какой целью появилась идея?"

**Новый вопрос:**
"Как вы думаете с какой целью эта идея внедрялась в ваш разум?"

**Где изменить:**
- В обработчике вопроса о цели идеи
- Вероятно в файле обработки психолога или в `app.py`

**Пример:**
```python
# Вместо:
question = "С какой целью появилась идея?"

# Использовать:
question = "Как вы думаете с какой целью эта идея внедрялась в ваш разум?"
```

---

## Новые события Socket.IO, которые нужно обработать на бэкенде

### 1. `update_belief_name`
Обновление названия убеждения.

**Параметры:**
- `session_id` - ID сессии
- `old_name` - старое название убеждения
- `new_name` - новое название убеждения

**Обработка:**
- Найти убеждение с `old_name` в сессии
- Обновить название на `new_name`
- Обновить все ссылки на это убеждение

### 2. `delete_belief`
Удаление убеждения.

**Параметры:**
- `session_id` - ID сессии
- `concept_name` - название убеждения для удаления

**Обработка:**
- Удалить убеждение из списка доступных концепций
- Удалить связанные данные

### 3. `strikethrough_belief`
Зачеркивание убеждения (помечает как неактуальное, но не удаляет).

**Параметры:**
- `session_id` - ID сессии
- `concept_name` - название убеждения

**Обработка:**
- Добавить флаг `is_strikethrough: true` к убеждению
- Сохранить в базе данных

### 4. `get_concept_full`
Получение полной структуры концепции.

**Параметры:**
- `session_id` - ID сессии
- `concept_name` - название концепции

**Ответ (emit `concept_full_structure`):**
```json
{
    "concept_name": "название",
    "structure": {
        "goal": "цель",
        "parts": ["часть1", "часть2"],
        "founder": "основатель",
        "consequences_emotional": ["эмоция1", "эмоция2"],
        "consequences_physical": ["физическое1"],
        "conclusion": "вывод"
    }
}
```

### 5. `extract_concept_part`
Извлечение части концепции как новой идеи.

**Параметры:**
- `session_id` - ID сессии
- `source_concept` - исходная концепция
- `part_type` - тип части (goal, parts, founder, etc.)
- `part_value` - значение части

**Обработка:**
- Создать новую концепцию с извлеченной частью
- Добавить в список доступных концепций
- Отправить подтверждение клиенту

---

## Рекомендации по реализации

1. Все изменения должны быть обратно совместимыми
2. Проверять существование полей перед доступом
3. Логировать все изменения для отладки
4. Обновлять список `available_concepts` после изменений

