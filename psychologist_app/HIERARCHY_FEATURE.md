# Иерархическое отображение идей

## Описание

Добавлена функция отображения иерархии идей в списке убеждений. Теперь видно, какие идеи входят в какие, с визуальным отображением уровней вложенности.

## Как это работает

### Структура данных

Иерархия строится на основе поля `extracted_from` в концепциях:
- Если у концепции есть `extracted_from` = "Название родителя", она является дочерней
- Если `extracted_from` отсутствует, концепция является корневой

### Визуальное отображение

1. **Отступы:** Каждый уровень вложенности имеет отступ 20px
2. **Иконки раскрытия:** ▶ для свернутых, ▼ для развернутых
3. **Цветные границы:** Разные цвета для разных уровней:
   - Уровень 0 (корневые): синяя граница
   - Уровень 1: зеленая граница, светло-серый фон
   - Уровень 2: желтая граница, светло-желтый фон
   - Уровень 3: голубая граница, светло-голубой фон
   - Уровень 4+: серая граница

4. **Раскрытие/сворачивание:** Клик на иконку ▶/▼ раскрывает/сворачивает дочерние идеи

---

## Пример отображения

### До изменений (плоский список):
```
1. Желание реализовать свой гений
2. из желания реализовать свой гений
3. способность создавать сильный ИИ
4. способность разрабатывать сильный ИИ
5. гений
```

### После изменений (иерархия):
```
▶ Желание реализовать свой гений
  ▼ из желания реализовать свой гений
    ▶ способность создавать сильный ИИ
    ▶ способность разрабатывать сильный ИИ
  ▶ гений
```

---

## Изменения в коде

### Backend (app_template.py)

#### 1. Новый обработчик `get_concepts_hierarchy`

```python
@socketio.on('get_concepts_hierarchy')
def handle_get_concepts_hierarchy(data):
    """Получение иерархии концепций для отображения структуры"""
    session_id = data.get('session_id')
    session_data = get_session(session_id)
    concepts = session_data.get('concepts', {})
    
    hierarchy = build_concepts_hierarchy(concepts)
    
    emit('concepts_hierarchy', {
        'hierarchy': hierarchy,
        'concepts': concepts
    })
```

#### 2. Функция построения иерархии

```python
def build_concepts_hierarchy(concepts):
    """
    Строит иерархию концепций на основе связей extracted_from
    """
    # Находим корневые концепции
    # Строим дерево с уровнями вложенности
    # Возвращаем иерархическую структуру
```

**Структура возвращаемых данных:**
```json
[
  {
    "name": "Желание реализовать свой гений",
    "level": 0,
    "children": [
      {
        "name": "из желания реализовать свой гений",
        "level": 1,
        "children": [
          {
            "name": "способность создавать сильный ИИ",
            "level": 2,
            "children": []
          }
        ]
      }
    ],
    "concept_data": { ... }
  }
]
```

---

### Frontend (app.js)

#### 1. Функция построения иерархии

```javascript
function buildConceptsHierarchy(concepts, conceptsData) {
    // Строит иерархию на основе extracted_from
    // Возвращает дерево с уровнями
}
```

#### 2. Функция отображения иерархии

```javascript
function renderHierarchyList(container, hierarchy, editMode, onSelect, onView) {
    // Отображает иерархию с отступами и иконками
    // Поддерживает раскрытие/сворачивание
}
```

#### 3. Обновленная функция модального окна

```javascript
function showBeliefSelectionModal(concepts) {
    // Запрашивает иерархию с сервера
    // Отображает иерархический список
}
```

---

### CSS (style.css)

Добавлены стили для:
- Отступов по уровням (`.belief-hierarchy-indent`)
- Иконок раскрытия (`.belief-expand-icon`)
- Цветных границ по уровням (`.belief-level-0`, `.belief-level-1`, etc.)
- Контейнера для дочерних элементов (`.belief-children`)

---

## Интеграция

### Шаг 1: Backend

1. Добавьте функцию `build_concepts_hierarchy()` в ваш `app.py`
2. Добавьте обработчик `@socketio.on('get_concepts_hierarchy')`
3. Убедитесь, что концепции сохраняют поле `extracted_from`

### Шаг 2: Frontend

1. Функции уже добавлены в `app.js`
2. CSS стили уже добавлены в `style.css`
3. Модальное окно автоматически запрашивает иерархию

---

## Использование

### Автоматическое отображение

Когда пользователь открывает список убеждений:
1. Система запрашивает иерархию с сервера
2. Отображает иерархический список
3. Пользователь может раскрывать/сворачивать ветки

### Ручной запрос иерархии

```javascript
socket.emit('get_concepts_hierarchy', {
    session_id: currentSessionId
});

socket.on('concepts_hierarchy', function(data) {
    const hierarchy = data.hierarchy;
    const concepts = data.concepts;
    // Используйте иерархию для отображения
});
```

---

## Примеры иерархий

### Пример 1: Простая иерархия

```
▶ Желание изменить восприятие людей через форму
  ▼ создать последователей
    ▶ массовое движение
  ▶ продукт для изменения восприятия
```

### Пример 2: Многоуровневая иерархия

```
▶ Желание реализовать свой гений
  ▼ из желания реализовать свой гений
    ▼ способность создавать сильный ИИ
      ▶ разработка алгоритмов
      ▶ обучение моделей
    ▶ способность разрабатывать сильный ИИ
  ▶ гений
```

---

## Особенности

1. **Автоматическое обновление:** Иерархия обновляется после создания/изменения концепций
2. **Раскрытие по умолчанию:** Все ветки свернуты, пользователь раскрывает нужные
3. **Сохранение состояния:** Можно добавить сохранение раскрытых веток в localStorage
4. **Обработка циклов:** Если есть циклические ссылки, они обрабатываются корректно

---

## Дополнительные улучшения (опционально)

### 1. Сохранение состояния раскрытия

```javascript
// Сохраняем раскрытые ветки
const expandedBranches = new Set();
// При раскрытии добавляем в Set
// При загрузке восстанавливаем состояние
```

### 2. Поиск в иерархии

```javascript
function searchInHierarchy(hierarchy, query) {
    // Рекурсивный поиск по дереву
    // Автоматическое раскрытие найденных веток
}
```

### 3. Счетчик дочерних элементов

```javascript
// Показывать количество дочерних элементов рядом с иконкой
// Например: "▶ (3)" если есть 3 дочерние идеи
```

---

## Готово!

После интеграции список убеждений будет отображать иерархию с:
- ✅ Визуальными отступами по уровням
- ✅ Цветными границами для разных уровней
- ✅ Возможностью раскрывать/сворачивать ветки
- ✅ Понятной структурой вложенности

